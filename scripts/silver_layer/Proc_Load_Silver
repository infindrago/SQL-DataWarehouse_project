*****************************************************
/* 
This Script contains a Stored procedure which Insert The data From csv Files 
By truncationg the data First And Updating It later 
It Will also used for perfomace metrix as this will Show How much time it takes 
To load the data in tables 

*/




if OBJECT_ID ('silver.load_data_Layer','P') is not null
drop procedure  silver.load_data_Layer



Create or alter procedure silver.load_data_Layer as
declare @StartTabletime datetime,@stopTime datetime , @StartTimeProcedure datetime ,@StopTimeProcedure datetime 
Begin 
begin try
  
  set @StartTimeProcedure=GETDATE();
  print 'Starting  Time For procedure is '+cast(@StartTimeProcedure as Nvarchar) 
------------------------------------
print '******************************'
print 'Loading Crm Tables '
print '******************************'
------------------------------------
Print 'Truncating Table silver.crm_cust_info ';
truncate table silver.crm_cust_info
set @StartTabletime = GETDATE();
insert into silver.crm_cust_info
(	cst_id,
	cstkey,
	cst_firstname,
	cst_lastname,
	cst_marital_status,
	cst_gndr,
	cst_create_date
)
select
	cst_id ,
	cstkey ,
	trim(cst_firstname) cst_firstname ,
	Trim(cst_lastname) cst_lastname ,
	case 
	when upper(trim(cst_marital_status))='M' then 'MARRIED'
	when upper(trim(cst_marital_status))='S' then 'SINGLE'
	else 'N/A'  
	end as cst_marital_status ,
	case 
	when upper(trim(cst_gndr))='M' then 'MALE'
	when upper(trim(cst_gndr))='F' then 'FEMALE'
	else 'N/A'  
	end as cst_gndr,
	cst_create_date  from(
select *,ROW_NUMBER()over(partition by cst_id order by cst_create_date desc) as Ranking
from bronze.crm_cust_info
)t 
where Ranking=1;
set @stopTime = GETDATE();

print 'Loading time - '+cast( datediff(second,@StartTabletime,@stopTime) as nvarchar)

Print '############################## ';

set @StartTabletime = GETDATE();
Print 'Truncating Table silver.crm_prd_info ';
truncate table silver.crm_prd_info
insert into silver.crm_prd_info
(
	prd_id ,
    cat_id,
	prdkey,
	prd_nm ,
	prd_cost ,
	prd_line ,
	prd_start_dt ,
	prd_end_dt 

)
select 
	prd_id ,
	replace(substring(prdkey,1,5),'-','_')as cat_id ,
	substring(prdkey,7,len(prdkey))as prdkey,
	prd_nm ,
	isnull(prd_cost,0)prd_cost,
	case 
	when upper(trim(prd_line))='R'then 'ROAD'
	when upper(trim(prd_line))='S'then 'OTHER SALES'
	when upper(trim(prd_line))='M'then 'MOUNTAIN'
	when upper(trim(prd_line))='T'then 'TOURING'
	ELSE 'N/A'
	END AS prd_line,
	prd_start_dt,
	dateadd(DAY,-1,LEAD(prd_start_dt)over(partition by prdkey order by prd_start_dt asc )) as prd_end_dt
	from bronze.crm_prd_info
	set @stopTime = GETDATE();

	print 'Loading time - '+cast( datediff(second,@StartTabletime,@stopTime) as nvarchar);


	Print '############################## ';

    set @StartTabletime = GETDATE();
	Print 'Truncating Table silver.crm_sales_details ';
	truncate table silver.crm_sales_details
	Insert into silver.crm_sales_details(
	sls_ord_num,
	sls_prd_key,
	sls_cust_id,
	sls_order_dt,
	sls_due_dt,
	sls_ship_dt,
	sls_sales,
	sls_price
	,sls_quantity)

	select
	sls_ord_num,
	sls_prd_key,
	sls_cust_id,
	case 
	when sls_order_dt=0 or len(sls_order_dt)!=8 then null
	else 
	cast(cast(nullif(sls_order_dt,0) as nvarchar)as date) 
	end as sls_order_dt,
	case 
	when sls_due_dt=0 or len(sls_due_dt)!=8 then null
	else 
	cast(cast(nullif(sls_due_dt,0) as nvarchar)as date) 
	end as sls_due_dt,
	case 
	when sls_ship_dt=0 or len(sls_ship_dt)!=8 then null
	else 
	cast(cast(nullif(sls_ship_dt,0) as nvarchar)as date) 
	end as sls_ship_dt,
	case
	when sls_sales is null or sls_sales<0 or sls_sales != abs(sls_price)*sls_quantity
	then abs(sls_price)*sls_quantity
	else sls_sales
	end as sls_sales,
	case
	when sls_price is null or sls_price<0 or sls_price != abs(sls_sales)/sls_quantity
	then abs(sls_sales)/nullif(sls_quantity,0)
	else sls_price
	end as sls_price,
	sls_quantity
	
	from bronze.crm_sales_details

	Print '############################## ';
	set @stopTime = GETDATE();

print 'Loading time - '+cast( datediff(second,@StartTabletime,@stopTime) as nvarchar)

    set @StartTabletime = GETDATE();
	Print 'Truncating Table silver.erp_cust_az12 ';
	truncate table silver.erp_cust_az12
	insert into silver.erp_cust_az12(c_id,bdate,gen)

	select 
	case 
	when c_id like 'NAS%' then substring(c_id,4,len(c_id))
	else c_id
	end as c_id,
	case 
	when bdate>GETDATE() or bdate<'1925-01-01'then null
	else bdate
	end as bdate ,
	case 
	when upper(TRIM(gen)) in ('F','Female') then 'Female'
	when upper(TRIM(gen)) in ('M','Male') then 'Male'
	else 'N/A'
	end as gen
	from 
	bronze.erp_cust_az12 
		set @stopTime = GETDATE();
	 print 'Loading time - '+cast( datediff(second,@StartTabletime,@stopTime) as nvarchar)



    Print '############################## ';
	set @StartTabletime = GETDATE();
	Print 'Truncating Table silver.erp_loc_a101 ';
	truncate table silver.erp_loc_a101
    insert into silver.erp_loc_a101(c_id,country)
    
	select 
	trim(replace(c_id,'-','') )as nn,
	case 
	when trim(country) in ('USA','United States','US') then 'United States'
	when trim(country) in ('DE') then 'Germany'
	when trim(country)='' then  null
	else country
	end as country
	from bronze.erp_loc_a101
	set @stopTime = GETDATE();

	print 'Loading time - '+cast( datediff(second,@StartTabletime,@stopTime) as nvarchar)

	Print '############################## ';
	set @StartTabletime = GETDATE();
	Print 'Truncating Table silver.erp_px_cat_g1v2 ';
	truncate table silver.erp_px_cat_g1v2
	insert into silver.erp_px_cat_g1v2 (category,subcategory,maintenance,id)
	select category,
	subcategory,
	maintenance,
	id  
	from bronze.erp_px_cat_g1v2
	set @stopTime = GETDATE();
    print 'Loading time - '+cast( datediff(second,@StartTabletime,@stopTime) as nvarchar)

	set @StopTimeProcedure = getdate();
	print 'Loding Time For procedure is '+cast(datediff(second,@StartTimeProcedure,@StopTimeProcedure) as Nvarchar)

	end try
	begin catch 
	   print 'Error message '+ error_message()
	    print 'Error state '+ cast(error_state()as nvarchar)
		 print 'Error number '+ cast(error_number()as nvarchar)

	end catch



	End 

